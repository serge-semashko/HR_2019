[comments]
[end]

[description]
[end]
[parameters]
    LOG=ON
[end]

[init map]
    <script>
        var mbUrl ='https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
        var mymap = L.map('mapid').setView([56.75859, 37.218719], 15);
        L.tileLayer(mbUrl,
            {
            maxZoom: 22,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/streets-v11'
        }).addTo(mymap);
        mymap.on('zoomend', function() {
            var dzoom =8-(( 22-mymap.getZoom())/1.3);
            if ( dzoom<=0) {dzoom=1};
            for (a in roads) {
                var obj=roads[a].leaflet_obj;
                obj.setStyle({weight:dzoom});
                console.log('dzoom='+dzoom)

            }

        });
    </script>

[end]

[init osmmap]
<script>
    osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      osmAttribution = 'Map data <a target="_blank" href="http://www.openstreetmap.org">OpenStreetMap.org</a>' +
        ' contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
      osmLayer = new L.TileLayer(osmUrl, {
          maxZoom: 19,
          attribution: osmAttribution
        }),
//      weatherLayer = new OsmJs.Weather.LeafletLayer({
//          lang: 'ru'
//        }),
      baseMaps = {"OpenStreetMap": osmLayer},
//      overlayMaps = {"Метеоданные": weatherLayer},
//      layersControl = new L.Control.Layers(baseMaps, overlayMaps),
      layersControl = new L.Control.Layers(baseMaps),
      mymap = new L.Map('mapid', {
          center: new L.LatLng(56.75859, 37.218719),
          zoom: 15,
          layers: [osmLayer]
        }),
      popup = new L.Popup();
    mymap.addControl(layersControl);
        mymap.on('zoomend', function() {
            var dzoom =8-(( 22-mymap.getZoom())/1.3);
            if ( dzoom<=0) {dzoom=1};
            for (a in roads) {
                var obj=roads[a].leaflet_obj;
                obj.setStyle({weight:dzoom});
                console.log('zoom='+mymap.getZoom()+' dzoom='+dzoom)

            }

        });

</script>
[end]


[init ymap]
<script>
    osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      osmAttribution = 'Map data <a target="_blank" href="http://www.openstreetmap.org">OpenStreetMap.org</a>' +
        ' contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',

      osmLayer = L.tileLayer(
  'http://vec{s}.maps.yandex.net/tiles?l=map&v=4.55.2&z={z}&x={x}&y={y}&scale=2&lang=ru_RU', {
    subdomains: ['01', '02', '03', '04'],
    attribution: '<a http="yandex.ru" target="_blank">Яндекс</a>',
    reuseTiles: true,
    updateWhenIdle: false
  }
),
      baseMaps = {"OpenStreetMap": osmLayer},
      layersControl = new L.Control.Layers(baseMaps),
      mymap = new L.Map('mapid', {
          center: new L.LatLng(56.75859, 37.218719),
          zoom: 19,
          layers: [osmLayer]
        }),
      popup = new L.Popup();
    mymap.options.crs = L.CRS.EPSG3395;
    mymap.addControl(layersControl);
        mymap.on('zoomend', function() {
            var dzoom =8-(( 22-mymap.getZoom())/1.3);
            if ( dzoom<=0) {dzoom=1};
            for (a in roads) {
                var obj=roads[a].leaflet_obj;
                obj.setStyle({weight:dzoom});
                console.log('zoom='+mymap.getZoom()+' dzoom='+dzoom)

            }

        });

</script>
[end]




[56.75859, 37.218719], 15


[get layers]
[end]
[init layers]
    
    $GET_DATA SQL:select CONCAT("'", NAME, "':'",descr,"',") as lrs  from map_layers order by descr;
    $SET_PARAMETERS lay={#lrs#}
    $LOG2 #lay# <br>
    <br>LRS #lay# <br>
    <script>
        console.log('begin');
    </script>
    <script>
        var lrs = #lay#;
        console.log('begin'+lrs);
    </script>
    <script>
        var lrs = #lay#;
        var overlays = {};
        var layers = {}
        var corps = {}

        for (el in lrs) {
          if (el.length==0)   break;
            console.log('layer:'+el);
            console.log(JSON.stringify(lrs[el]));

            var lr=L.layerGroup();
            overlays[lrs[el]] = lr;
            layers[el]=lr;
        }
        corps = layers['lhep_bulding'];
        var acc = layers['nica'];


        L.control.layers({},overlays).addTo(mymap);
    </script>
[end]
[get roads]
    select CONCAT("'", obj_name, 
        "':{'descr':'",descr,
        "','obj_name':'",obj_name,
        "','points':'",points,
        "','o_type':'",o_type,
        "'},") as roads  from map_lhep  order by obj_name
[end]
[init roads]
    $GET_DATA [get roads]
    $SET_PARAMETERS roads={#roads#}
    $LOG2 roads #roads# <br>
    $BREAK ??!roads

   <br> init roads '#roads#' <br> ??

    <script>
        var ovrls = [{},{},{}];
        function add_object(obj){
            var road = roads[el];
            console.log('begin el'+JSON.stringify(road));
            var lr=L.layerGroup();
            var descr  = road['descr'];
            if (road['o_type'] == 1) {
                    var rname  = 'Аллея '+road['obj_name'];
                } else {
                    var rname  = 'корпус '+road['obj_name'];
                }
            console.log('road descr'+rname);
            ovrls[road['o_type']][rname] = lr;
            var latlngs = JSON.parse(road['points']);
            if (road['o_type'] == 1) {
                var polyline = L.polyline(
                    latlngs
                , {color: '#e4b477', weight:4}).addTo(lr);
                } else {
                    var polyline = L.polygon(
                        latlngs
                    , {color: '#5f6e8d', weight:4}).addTo(lr);
                }
            polyline.bindPopup(rname).on;
            road['_leaflet_id'] = polyline._leaflet_id;
            road['leaflet_obj'] = polyline;
            console.log('1Create line ID= '+polyline._leaflet_id);
            polyline.on('edit', function() {
                
                for (el in roads) {
                    rt = roads[el] ;
                    if (rt['_leaflet_id'] !=  this._leaflet_id) {
                        continue;
                    }
                    var a = this._latlngs;
//                    console.log('Нашел!!!');
                    var a = this.editing.latlngs[0];
                    var bb = rt['leaflet_obj'].getLatLngs();
                    if (bb.length==1) {a = bb[0]} else {a=bb};
                    var new_l=[];
                     console.log('a='+(typeof a)+' '+a);
                        for (i in a){
                            console.log('I='+(typeof i)+' '+i+' A='+(typeof a[i])+' '+a[i] );
                            var b = a[i];
                            var t = a[i];
                            var t1 = t['lat'];
                            var t2 = t['lng'];
                            new_l.push([t1,t2]);

                        }
                    var coord = JSON.stringify(new_l);
                    console.log(coord);
                    console.log('ID= '+this._leaflet_id);
                    var aa = this._latlngs;
                    if ( coord.indexOf("null") >= 0 ){
                        debugger;
                        aaa();
                    }
                    if ( coord.length <20 ){
                        debugger;
                        alert('Ошибка поиска объекта');
                        aaa();
                    }

                    AjaxCall('popupCont', 'c=maps/save_map_object&o_type='+rt['o_type']+'&coord='+coord+'&objname='+el, true);  

                    break;

                }
                    
            });

            lr.addTo(mymap);
            debugger;
            var tbl= $('##table_bld')[0];
//            var tbl= document.getElementById('table_bld');
            var row=tbl.insertRow( -1);
            var c1 = row.insertCell()
            c1.innerHTML = rname;
            var c1 = row.insertCell;
            var c1 = row.insertCell;
            
            polyline.on(
                 'click',
                 function(e) {
                   L.DomEvent.stopPropagation(e);
                 });
        }
        function obj_click(a){
        }
        var roads = #roads#;
        var overlays = {};
        for (el in roads) {
            if (el.length==0)   break;
            console.log('===================== el = '+el);
            var road = roads[el];
            console.log(el+' = '+JSON.stringify(road));
            add_object(road);

        }

        L.control.layers({},ovrls[1]).addTo(mymap);
        L.control.layers({},ovrls[2]).addTo(mymap);
    </script>
    
[end]





[init poly]
[end]
[init resize]
  <script>
    document.onresize = function () {
        var w = screen.width;
        var h = screen.height;
        var dv = document.getElementById('mapid');
        console.log('mapid='+dv)
        dv.style.width = w*0.8+"px";
        dv.style.height = h*0.8+"px";
    }
</script>

[end]
[report]
    $LOG2 maps ========================<br>
        <input id=modebox type="checkbox" name=mode value='view'
            style="display:none" ??!USER_ID=3663&!USER_ID=9056&!USER_ID=3305
        onClick="
            cb = $(this);
            var editMode = cb.prop('checked');
            for (a in roads) {
                var obj=roads[a].leaflet_obj;
                if ( editMode ) {
                        obj.editing.enable();}
                    else {
                        obj.editing.disable();
                    }

            }
            if ( editMode ) {
//                $('##coord').show();
//                $('##SaveBTN_a').show();
//                $('##objname').show();
//                $('##ClearBTN').show();
//                $('##SaveBTN_b').show();
                $('##edit_controls').show();
            } else {
//                $('##coord').attr('disabled','disabled');
//                $('##SaveBTN_a').hide();
//                $('##SaveBTN_b').hide();
//                $('##ClearBTN').hide();
//                $('##objname').hide();
//                $('##coord').hide();
                $('##edit_controls').hide();
                
            }
        "
        >
          <b
                      style="display:none" ??!USER_ID=3663&!USER_ID=9056&!USER_ID=3305
            >
              Режим редактирования
          </b>
<div id=edit_controls style="display:none">
        </input>
    
        <input type=text id=coord value='' size=200   ><br>
        <b id=objlbl    >Наименование</b> 
        <input type=text id=objname value='' size=100   >
        <input type=button id=ClearBTN value='Очистить'   onClick=" 
            oldcoord=$('##coord').val('');
        ">
        <input type=button id=SaveBTN_a value='Сохранить аллею'    onclick="
          AjaxCall('popupCont', 'c=maps/save_map_object&o_type=1&coord='+$('##coord').val()+'&objname='+$('##objname').val(), true);  
          oldcoord=$('##coord').val('');
        "
        >
        <input type=button id=SaveBTN_b value='Сохранить здание' style="display:none"   onclick="
          AjaxCall('popupCont', 'c=maps/save_map_object&o_type=2&coord='+$('##coord').val()+'&objname='+$('##objname').val(), true);  
          oldcoord=$('##coord').val('');
        "
        >
</div>
    <div>
        <div id="mapid" style="width: 70%; height: 80%;float:left"></div>
        <div id="listid" style="width: 30%; height: 80%;float:right">
         <table id=table_bld border=1>
         </table>
         <table id=table_roads border=1>
         </table>
        </div>
    </div>    
    $INCLUDE [init resize]
    $INCLUDE [init osmmap]
    $INCLUDE [init layers] ??
    $INCLUDE [init roads]
    $INCLUDE [init buildings] ??
    $INCLUDE [init icon]

<script>
    var popup = L.popup();
    
    L.marker([56.7581634406245,37.211272716522224], {icon: gateIcon}).bindPopup("Проходная").addTo(mymap);


    function onMapClick(e) {
        navigator.clipboard.writeText(e.latlng.lat+','+e.latlng.lng);
            var oldcoord=$('##coord').val();
            if (oldcoord.length>0){
                oldcoord = oldcoord+',';
            }
           $('##coord').val(oldcoord+'['+e.latlng.lat+','+e.latlng.lng+']');
    }

    mymap.on('click', onMapClick);

    </script>

[end]

// var markers = L.markerClusterGroup();
//    L.marker([56.75, 37.19]).addTo(mymap)
//        .bindPopup("<b>Hello world!<br />I am a popup.").openPopup();
//    L.circle([56.72, 37.19], 500, {
//        color: 'red',
//        fillColor: '#f03',
//        fillOpacity: 0.5
//    }).addTo(mymap).bindPopup("I am a circle.");

    var LeafIcon = L.Icon.extend({
        options: {
            ashadowUrl: 'leaf-shadow.png',
            iconSize:     [38, 45],
            shadowSize:   [20, 64],
            iconAnchor:   [20, 43],
            shadowAnchor: [4, 62],
            popupAnchor:  [-3, -36]
        }
    });

    var greenIcon = new LeafIcon({iconUrl: 'images/leaf-green.png'}),
        redIcon = new LeafIcon({iconUrl: 'images/leaf-red.png'}),
        orangeIcon = new LeafIcon({iconUrl: 'images/leaf-orange.png'}),
        gateIcon = new LeafIcon({iconUrl: 'images/JINR.png'});


[init icon]
<script>
    var LeafIcon = L.Icon.extend({
        options: {
            ashadowUrl: 'leaf-shadow.png',
            iconSize:     [38, 45],
            shadowSize:   [20, 64],
            iconAnchor:   [20, 43],
            shadowAnchor: [4, 62],
            popupAnchor:  [-3, -36]
        }
    });

    var greenIcon = new LeafIcon({iconUrl: 'images/leaf-green.png'}),
        redIcon = new LeafIcon({iconUrl: 'images/leaf-red.png'}),
        orangeIcon = new LeafIcon({iconUrl: 'images/leaf-orange.png'}),
        gateIcon = new LeafIcon({iconUrl: 'images/JINR.png'});
</script>

[end]
